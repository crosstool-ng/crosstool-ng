# ncurses 6.5 - patch 20240831 - Thomas E. Dickey
#
# ------------------------------------------------------------------------------
#
# Ncurses 6.5 is at
#   https://invisible-island.net/archives/ncurses/
#   https://invisible-mirror.net/archives/ncurses/
#   https://ftp.gnu.org/gnu/ncurses/
#
# Patches for ncurses 6.5 can be found at
#   https://invisible-island.net/archives/ncurses/6.5
#   https://invisible-mirror.net/archives/ncurses/6.5
#
# ------------------------------------------------------------------------------
# https://invisible-island.net/archives/ncurses/6.5/ncurses-6.5-20240831.patch.gz
# patch by Thomas E. Dickey <dickey@invisible-island.net>
# created  Sat Aug 31 22:36:56 UTC 2024
# ------------------------------------------------------------------------------
# NEWS                             |   14 +++++++++++++-
# VERSION                          |    2 +-
# configure                        |    4 ++--
# configure.in                     |    6 +++---
# dist.mk                          |    4 ++--
# include/nc_mingw.h               |    8 +++++---
# include/nc_win32.h               |    8 +++++---
# include/win32_curses.h           |    7 ++-----
# ncurses/base/lib_getch.c         |   10 +++++-----
# ncurses/curses.priv.h            |   32 ++++++++++++++++++++++++++------
# ncurses/tinfo/lib_napms.c        |    6 +++---
# ncurses/tinfo/lib_print.c        |    4 ++--
# ncurses/tinfo/lib_setup.c        |    7 +++----
# ncurses/tinfo/lib_win32con.c     |    6 +++---
# ncurses/tinfo/lib_win32util.c    |    8 ++++----
# ncurses/tinfo/tinfo_driver.c     |    4 ++--
# ncurses/tinfo/write_entry.c      |    4 ++--
# ncurses/trace/lib_trace.c        |    4 ++--
# ncurses/widechar/widechars.c     |    8 ++++----
# package/debian-mingw/changelog   |    4 ++--
# package/debian-mingw64/changelog |    4 ++--
# package/debian/changelog         |    4 ++--
# package/mingw-ncurses.nsi        |    4 ++--
# package/mingw-ncurses.spec       |    2 +-
# package/ncurses.spec             |    2 +-
# package/ncursest.spec            |    2 +-
# test/dots_termcap.c              |    8 ++++----
# test/dots_xcurses.c              |    6 +++---
# test/rain.c                      |    6 +++---
# test/test.priv.h                 |   10 +++++-----
# test/test_mouse.c                |    4 ++--
# test/widechars.h                 |    4 ++--
# 32 files changed, 119 insertions(+), 87 deletions(-)
# ------------------------------------------------------------------------------
Index: NEWS
Prereq:  1.4166 
--- ncurses-6.5-20240824+/NEWS	2024-08-24 20:11:44.000000000 +0000
+++ ncurses-6.5-20240831/NEWS	2024-08-31 21:21:26.000000000 +0000
@@ -26,7 +26,7 @@
 -- sale, use or other dealings in this Software without prior written        --
 -- authorization.                                                            --
 -------------------------------------------------------------------------------
--- $Id: NEWS,v 1.4166 2024/08/24 20:11:44 tom Exp $
+-- $Id: NEWS,v 1.4169 2024/08/31 21:21:26 tom Exp $
 -------------------------------------------------------------------------------
 
 This is a log of changes that ncurses has gone through since Zeyd started
@@ -46,6 +46,18 @@
 Changes through 1.9.9e did not credit all contributions;
 it is not possible to add this information.
 
+20240831
+	+ build-fix for a case in msys2 where gettimeofday() was available but
+	  the fallback was partly configured.
+	> patch by Rafael Kitover:
+	+ separate the _NC_WINDOWS platform macro into _NC_WINDOWS_NATIVE,
+	  for MinGW and other native Win32 support, and _NC_WINDOWS, to make
+	  some Win32 features available under the Cygwin runtime, in this case
+	  the term-driver.
+	+ make some minor adjustments to allow
+	      ./configure --enable-term-driver
+	  to also work on Cygwin platforms such as Cygwin and MSYS2.
+
 20240824
 	+ modify infocmp and tabs to use actual name in usage and header.
 	+ modify test/demo_keyok.c to accept ^Q for quit, for consistency.
Index: VERSION
--- ncurses-6.5-20240824+/VERSION	2024-08-24 10:17:07.000000000 +0000
+++ ncurses-6.5-20240831/VERSION	2024-08-31 09:52:35.000000000 +0000
@@ -1 +1 @@
-5:0:10	6.5	20240824
+5:0:10	6.5	20240831
Index: configure
--- ncurses-6.5-20240824+/configure	2024-08-17 13:44:13.000000000 +0000
+++ ncurses-6.5-20240831/configure	2024-08-31 21:01:19.000000000 +0000
@@ -1,5 +1,5 @@
 #! /bin/sh
-# From configure.in Revision: 1.785 .
+# From configure.in Revision: 1.786 .
 # Guess values for system-dependent variables and create Makefiles.
 # Generated by Autoconf 2.52.20240618.
 #
@@ -28526,7 +28526,7 @@
 if test "$with_term_driver" != no ; then
 	LIB_SUBSETS="${LIB_SUBSETS}+port_drivers"
 	case "$cf_cv_system_name" in
-	(*mingw32*|*mingw64*)
+	(*mingw32*|*mingw64*|*msys*|*cygwin*)
 		if test "x$with_exp_win32" = xyes ; then
 			LIB_SUBSETS="${LIB_SUBSETS}+port_tinfo+port_win32"
 		else
Index: configure.in
Prereq:  1.785 
--- ncurses-6.5-20240824+/configure.in	2024-08-17 13:44:13.000000000 +0000
+++ ncurses-6.5-20240831/configure.in	2024-08-31 10:46:01.000000000 +0000
@@ -29,7 +29,7 @@
 dnl
 dnl Author: Thomas E. Dickey 1995-on
 dnl
-dnl $Id: configure.in,v 1.785 2024/08/17 13:44:13 tom Exp $
+dnl $Id: configure.in,v 1.786 2024/08/31 10:46:01 Rafael.Kitover Exp $
 dnl Process this file with autoconf to produce a configure script.
 dnl
 dnl For additional information, see
@@ -38,7 +38,7 @@
 dnl
 dnl ---------------------------------------------------------------------------
 AC_PREREQ(2.52.20210101)
-AC_REVISION($Revision: 1.785 $)
+AC_REVISION($Revision: 1.786 $)
 AC_INIT(ncurses/base/lib_initscr.c)
 AC_CONFIG_HEADER(include/ncurses_cfg.h:include/ncurses_cfg.hin)
 
@@ -2075,7 +2075,7 @@
 if test "$with_term_driver" != no ; then
 	LIB_SUBSETS="${LIB_SUBSETS}+port_drivers"
 	case "$cf_cv_system_name" in
-	(*mingw32*|*mingw64*)
+	(*mingw32*|*mingw64*|*msys*|*cygwin*)
 		if test "x$with_exp_win32" = xyes ; then
 			LIB_SUBSETS="${LIB_SUBSETS}+port_tinfo+port_win32"
 		else
Index: dist.mk
Prereq:  1.1628 
--- ncurses-6.5-20240824+/dist.mk	2024-08-24 10:17:07.000000000 +0000
+++ ncurses-6.5-20240831/dist.mk	2024-08-31 09:52:35.000000000 +0000
@@ -26,7 +26,7 @@
 # use or other dealings in this Software without prior written               #
 # authorization.                                                             #
 ##############################################################################
-# $Id: dist.mk,v 1.1628 2024/08/24 10:17:07 tom Exp $
+# $Id: dist.mk,v 1.1629 2024/08/31 09:52:35 tom Exp $
 # Makefile for creating ncurses distributions.
 #
 # This only needs to be used directly as a makefile by developers, but
@@ -38,7 +38,7 @@
 # These define the major/minor/patch versions of ncurses.
 NCURSES_MAJOR = 6
 NCURSES_MINOR = 5
-NCURSES_PATCH = 20240824
+NCURSES_PATCH = 20240831
 
 # We don't append the patch to the version, since this only applies to releases
 VERSION = $(NCURSES_MAJOR).$(NCURSES_MINOR)
Index: include/nc_mingw.h
Prereq:  1.12 
--- ncurses-6.5-20240824+/include/nc_mingw.h	2024-05-04 19:16:38.000000000 +0000
+++ ncurses-6.5-20240831/include/nc_mingw.h	2024-08-31 15:50:24.000000000 +0000
@@ -31,12 +31,14 @@
  * Author: Thomas Dickey, 2008-on                                           *
  ****************************************************************************/
 
-/* $Id: nc_mingw.h,v 1.12 2024/05/04 19:16:38 tom Exp $ */
+/* $Id: nc_mingw.h,v 1.13 2024/08/31 15:50:24 tom Exp $ */
 
 #ifndef NC_MINGW_H
 #define NC_MINGW_H 1
 
-#ifdef _WIN32
+#include <ncurses_cfg.h>
+
+#if defined(_WIN32) || defined(__MSYS__) || defined(__CYGWIN__)
 
 #ifdef WINVER
 #  if WINVER < 0x0501
@@ -85,6 +87,6 @@
 }
 #endif
 
-#endif /* _WIN32 */
+#endif /* _WIN32|__MSYS__|__CYGWIN__ */
 
 #endif /* NC_MINGW_H */
Index: include/nc_win32.h
Prereq:  1.12 
--- ncurses-6.5-20240824+/include/nc_win32.h	2024-05-04 19:17:03.000000000 +0000
+++ ncurses-6.5-20240831/include/nc_win32.h	2024-08-31 18:17:21.000000000 +0000
@@ -31,15 +31,17 @@
  * Author: Thomas Dickey, 2008-on                                           *
  ****************************************************************************/
 
-/* $Id: nc_win32.h,v 1.12 2024/05/04 19:17:03 tom Exp $ */
+/* $Id: nc_win32.h,v 1.13 2024/08/31 18:17:21 tom Exp $ */
 
 #ifndef NC_WIN32_H
 #define NC_WIN32_H 1
 
+#include <ncurses_cfg.h>
+
 #if defined(_WIN32) || defined(_WIN64)
 
-#ifndef _NC_WINDOWS
-#define _NC_WINDOWS
+#ifndef _NC_WINDOWS_NATIVE
+#define _NC_WINDOWS_NATIVE
 #endif
 
 #ifdef TERMIOS
Index: include/win32_curses.h
Prereq:  1.3 
--- ncurses-6.5-20240824+/include/win32_curses.h	2021-06-17 21:26:02.000000000 +0000
+++ ncurses-6.5-20240831/include/win32_curses.h	2024-08-31 18:17:44.000000000 +0000
@@ -1,5 +1,5 @@
 /****************************************************************************
- * Copyright 2018-2020,2021 Thomas E. Dickey                                *
+ * Copyright 2018-2021,2024 Thomas E. Dickey                                *
  * Copyright 2008-2014,2017 Free Software Foundation, Inc.                  *
  *                                                                          *
  * Permission is hereby granted, free of charge, to any person obtaining a  *
@@ -31,7 +31,7 @@
  * Author: Juergen Pfeifer, 2008-on                                         *
  ****************************************************************************/
 
-/* $Id: win32_curses.h,v 1.3 2021/06/17 21:26:02 tom Exp $ */
+/* $Id: win32_curses.h,v 1.4 2024/08/31 18:17:44 tom Exp $ */
 
 /*
  * This is the interface we use on Windows to mimic the control of the settings
@@ -68,8 +68,5 @@
 #undef sleep
 #define sleep(n) Sleep((n) * 1000)
 
-#undef gettimeofday
-#define gettimeofday(tv,tz) _nc_gettimeofday(tv,tz)
-
 #endif /* _NC_WIN32_CURSES_H */
 #endif /* _WIN32||_WIN64 */
Index: ncurses/base/lib_getch.c
Prereq:  1.146 
--- ncurses-6.5-20240824+/ncurses/base/lib_getch.c	2023-04-29 18:57:12.000000000 +0000
+++ ncurses-6.5-20240831/ncurses/base/lib_getch.c	2024-08-31 15:54:49.000000000 +0000
@@ -1,5 +1,5 @@
 /****************************************************************************
- * Copyright 2018-2022,2023 Thomas E. Dickey                                *
+ * Copyright 2018-2023,2024 Thomas E. Dickey                                *
  * Copyright 1998-2015,2016 Free Software Foundation, Inc.                  *
  *                                                                          *
  * Permission is hereby granted, free of charge, to any person obtaining a  *
@@ -44,7 +44,7 @@
 #define NEED_KEY_EVENT
 #include <curses.priv.h>
 
-MODULE_ID("$Id: lib_getch.c,v 1.146 2023/04/29 18:57:12 tom Exp $")
+MODULE_ID("$Id: lib_getch.c,v 1.147 2024/08/31 15:54:49 tom Exp $")
 
 #include <fifo_defs.h>
 
@@ -135,7 +135,7 @@
 }
 
 #ifdef USE_TERM_DRIVER
-# if defined(_NC_WINDOWS) && !defined(EXP_WIN32_DRIVER)
+# if defined(_NC_WINDOWS_NATIVE) && !defined(EXP_WIN32_DRIVER)
 static HANDLE
 _nc_get_handle(int fd)
 {
@@ -163,7 +163,7 @@
 				   _nc_console_handle(sp->_ifd),
 				   delay EVENTLIST_2nd(evl));
     } else
-# elif defined(_NC_WINDOWS)
+# elif defined(_NC_WINDOWS_NATIVE)
     /* if we emulate terminfo on console, we have to use the console routine */
     if (IsTermInfoOnConsole(sp)) {
 	HANDLE fd = _nc_get_handle(sp->_ifd);
@@ -315,7 +315,7 @@
 				 &buf);
 	    _nc_set_read_thread(FALSE);
 	} else
-# elif defined(_NC_WINDOWS)
+# elif defined(_NC_WINDOWS_NATIVE)
 	if (NC_ISATTY(sp->_ifd) && IsTermInfoOnConsole(sp) && IsCbreak(sp))
 	    n = _nc_mingw_console_read(sp,
 				       _nc_get_handle(sp->_ifd),
Index: ncurses/curses.priv.h
Prereq:  1.689 
--- ncurses-6.5-20240824+/ncurses/curses.priv.h	2024-05-11 19:05:45.000000000 +0000
+++ ncurses-6.5-20240831/ncurses/curses.priv.h	2024-08-31 10:46:01.000000000 +0000
@@ -35,7 +35,7 @@
  ****************************************************************************/
 
 /*
- * $Id: curses.priv.h,v 1.689 2024/05/11 19:05:45 tom Exp $
+ * $Id: curses.priv.h,v 1.690 2024/08/31 10:46:01 Rafael.Kitover Exp $
  *
  *	curses.priv.h
  *
@@ -88,13 +88,24 @@
 #endif
 
 /* Some Windows related defines */
+
 #undef _NC_WINDOWS
-#if (defined(_WIN32) || defined(_WIN64))
+#if (defined(_WIN32) || defined(_WIN64__) || defined(__MSYS__) || defined(__CYGWIN__))
 #define _NC_WINDOWS
 #else
 #undef EXP_WIN32_DRIVER
 #endif
 
+#undef _NC_CYGWIN
+#if (defined(__MSYS__) || defined(__CYGWIN__))
+#define _NC_CYGWIN
+#endif
+
+#undef _NC_WINDOWS_NATIVE
+#if (defined(_WIN32) || defined(_WIN64))
+#define _NC_WINDOWS_NATIVE
+#endif
+
 #undef _NC_MINGW
 #if (defined(__MINGW32__) || defined(__MINGW64__))
 #define _NC_MINGW
@@ -197,7 +208,7 @@
  * the path separator in configure doesn't work properly. So, if building
  * for MinGW, we enforce the correct Windows PATH separator
  */
-#if defined(_NC_WINDOWS)
+#if defined(_NC_WINDOWS_NATIVE)
 #  ifdef NCURSES_PATHSEP
 #    undef NCURSES_PATHSEP
 #  endif
@@ -223,6 +234,15 @@
 #endif
 
 /*
+ * The stricmp() function is in MSVCRT, and cannot be called or linked from
+ * Cygwin runtime-dependent binaries currently. Use the POSIX strcaseccmp()
+ * function instead which is pretty much the same.
+ */
+#if defined(_NC_CYGWIN)
+#define stricmp(s1, s2) strcasecmp(s1, s2)
+#endif
+
+/*
  * Not all platforms have memmove; some have an equivalent bcopy.  (Some may
  * have neither).
  */
@@ -2238,7 +2258,7 @@
  */
 #if USE_WIDEC_SUPPORT
 
-#if defined(_NC_WINDOWS) && !defined(_NC_MSC) && !defined(EXP_WIN32_DRIVER)
+#if defined(_NC_WINDOWS_NATIVE) && !defined(_NC_MSC) && !defined(EXP_WIN32_DRIVER)
 /*
  * MinGW has wide-character functions, but they do not work correctly.
  */
@@ -2252,9 +2272,9 @@
 extern int __MINGW_NOTHROW _nc_mblen(const char *, size_t);
 #define mblen(s,n) _nc_mblen(s, n)
 
-#endif /* _NC_WINDOWS && !_NC_MSC */
+#endif /* _NC_WINDOWS_NATIVE && !_NC_MSC */
 
-#if defined(_NC_WINDOWS) || defined(_NC_MINGW)
+#if defined(_NC_WINDOWS_NATIVE) || defined(_NC_MINGW)
 /* see wcwidth.c */
 extern NCURSES_EXPORT(int) mk_wcwidth(uint32_t);
 #define wcwidth(ucs) _nc_wcwidth(ucs)
Index: ncurses/tinfo/lib_napms.c
Prereq:  1.28 
--- ncurses-6.5-20240824+/ncurses/tinfo/lib_napms.c	2023-09-16 16:09:33.000000000 +0000
+++ ncurses-6.5-20240831/ncurses/tinfo/lib_napms.c	2024-08-31 15:55:00.000000000 +0000
@@ -1,5 +1,5 @@
 /****************************************************************************
- * Copyright 2020,2023 Thomas E. Dickey                                     *
+ * Copyright 2020-2023,2024 Thomas E. Dickey                                *
  * Copyright 1998-2014,2017 Free Software Foundation, Inc.                  *
  *                                                                          *
  * Permission is hereby granted, free of charge, to any person obtaining a  *
@@ -52,7 +52,7 @@
 #endif
 #endif
 
-MODULE_ID("$Id: lib_napms.c,v 1.28 2023/09/16 16:09:33 tom Exp $")
+MODULE_ID("$Id: lib_napms.c,v 1.29 2024/08/31 15:55:00 tom Exp $")
 
 NCURSES_EXPORT(int)
 NCURSES_SP_NAME(napms) (NCURSES_SP_DCLx int ms)
@@ -78,7 +78,7 @@
 	    request = remaining;
 	}
     }
-#elif defined(_NC_WINDOWS)
+#elif defined(_NC_WINDOWS_NATIVE)
     Sleep((DWORD) ms);
 #else
     _nc_timed_wait(0, 0, ms, (int *) 0 EVENTLIST_2nd(0));
Index: ncurses/tinfo/lib_print.c
Prereq:  1.32 
--- ncurses-6.5-20240824+/ncurses/tinfo/lib_print.c	2024-07-27 19:22:23.000000000 +0000
+++ ncurses-6.5-20240831/ncurses/tinfo/lib_print.c	2024-08-31 10:46:01.000000000 +0000
@@ -40,7 +40,7 @@
 #define CUR SP_TERMTYPE
 #endif
 
-MODULE_ID("$Id: lib_print.c,v 1.32 2024/07/27 19:22:23 tom Exp $")
+MODULE_ID("$Id: lib_print.c,v 1.33 2024/08/31 10:46:01 Rafael.Kitover Exp $")
 
 NCURSES_EXPORT(int)
 NCURSES_SP_NAME(mcprint) (NCURSES_SP_DCLx char *data, int len)
@@ -98,7 +98,7 @@
      * kernel will ship the contiguous clist items from the last write
      * immediately.
      */
-#ifndef _NC_WINDOWS
+#ifndef _NC_WINDOWS_NATIVE
     (void) sleep(0);
 #endif
     free(mybuf);
Index: ncurses/tinfo/lib_setup.c
Prereq:  1.242 
--- ncurses-6.5-20240824+/ncurses/tinfo/lib_setup.c	2024-07-27 19:14:45.000000000 +0000
+++ ncurses-6.5-20240831/ncurses/tinfo/lib_setup.c	2024-08-31 21:15:54.000000000 +0000
@@ -49,7 +49,7 @@
 #include <locale.h>
 #endif
 
-MODULE_ID("$Id: lib_setup.c,v 1.242 2024/07/27 19:14:45 tom Exp $")
+MODULE_ID("$Id: lib_setup.c,v 1.244 2024/08/31 21:15:54 tom Exp $")
 
 /****************************************************************************
  *
@@ -334,7 +334,6 @@
 	char *s;
 	char cc;
 	const char *skipped;
-	int scanned;
 
 	s = memset(buf, '\0', sizeof(buf));
 	do {
@@ -350,7 +349,7 @@
 	cc = '\0';
 	if (skipped != buf
 	    && *skipped != '\0'
-	    && (scanned = sscanf(skip_csi(buf), "%d;%d%c", &y, &x, &cc)) == 3
+	    && sscanf(skip_csi(buf), "%d;%d%c", &y, &x, &cc) == 3
 	    && (cc == 'R')) {
 	    *row = y;
 	    *col = x;
@@ -759,7 +758,7 @@
     static int result = 0;
 
     if (!initialized) {
-#if defined(_NC_WINDOWS) && USE_WIDEC_SUPPORT
+#if defined(_NC_WINDOWS_NATIVE) && USE_WIDEC_SUPPORT
 	result = 1;
 #elif HAVE_LANGINFO_CODESET
 	char *env = nl_langinfo(CODESET);
Index: ncurses/tinfo/lib_win32con.c
Prereq:  1.14 
--- ncurses-6.5-20240824+/ncurses/tinfo/lib_win32con.c	2023-08-05 20:44:38.000000000 +0000
+++ ncurses-6.5-20240831/ncurses/tinfo/lib_win32con.c	2024-08-31 15:55:10.000000000 +0000
@@ -1,5 +1,5 @@
 /****************************************************************************
- * Copyright 2020-2021,2023 Thomas E. Dickey                                *
+ * Copyright 2020-2023,2024 Thomas E. Dickey                                *
  * Copyright 1998-2009,2010 Free Software Foundation, Inc.                  *
  *                                                                          *
  * Permission is hereby granted, free of charge, to any person obtaining a  *
@@ -38,9 +38,9 @@
 
 #include <curses.priv.h>
 
-MODULE_ID("$Id: lib_win32con.c,v 1.14 2023/08/05 20:44:38 tom Exp $")
+MODULE_ID("$Id: lib_win32con.c,v 1.15 2024/08/31 15:55:10 tom Exp $")
 
-#ifdef _NC_WINDOWS
+#if defined(_NC_WINDOWS)
 
 #ifdef _NC_MINGW
 #include <wchar.h>
Index: ncurses/tinfo/lib_win32util.c
Prereq:  1.4 
--- ncurses-6.5-20240824+/ncurses/tinfo/lib_win32util.c	2023-06-17 17:19:06.000000000 +0000
+++ ncurses-6.5-20240831/ncurses/tinfo/lib_win32util.c	2024-08-31 15:55:16.000000000 +0000
@@ -1,5 +1,5 @@
 /****************************************************************************
- * Copyright 2020-2021,2023 Thomas E. Dickey                                *
+ * Copyright 2020-2023,2024 Thomas E. Dickey                                *
  * Copyright 1998-2009,2010 Free Software Foundation, Inc.                  *
  *                                                                          *
  * Permission is hereby granted, free of charge, to any person obtaining a  *
@@ -34,9 +34,9 @@
 
 #include <curses.priv.h>
 
-MODULE_ID("$Id: lib_win32util.c,v 1.4 2023/06/17 17:19:06 tom Exp $")
+MODULE_ID("$Id: lib_win32util.c,v 1.5 2024/08/31 15:55:16 tom Exp $")
 
-#ifdef _NC_WINDOWS
+#ifdef _NC_WINDOWS_NATIVE
 #include <io.h>
 
 #ifdef _NC_CHECK_MINTTY
@@ -131,4 +131,4 @@
 }
 #endif // HAVE_GETTIMEOFDAY == 2
 
-#endif // _NC_WINDOWS
+#endif // _NC_WINDOWS_NATIVE
Index: ncurses/tinfo/tinfo_driver.c
Prereq:  1.75 
--- ncurses-6.5-20240824+/ncurses/tinfo/tinfo_driver.c	2024-05-11 19:20:44.000000000 +0000
+++ ncurses-6.5-20240831/ncurses/tinfo/tinfo_driver.c	2024-08-31 10:46:01.000000000 +0000
@@ -52,7 +52,7 @@
 # endif
 #endif
 
-MODULE_ID("$Id: tinfo_driver.c,v 1.75 2024/05/11 19:20:44 tom Exp $")
+MODULE_ID("$Id: tinfo_driver.c,v 1.76 2024/08/31 10:46:01 Rafael.Kitover Exp $")
 
 /*
  * SCO defines TIOCGSIZE and the corresponding struct.  Other systems (SunOS,
@@ -1504,7 +1504,7 @@
 
 static DRIVER_ENTRY DriverTable[] =
 {
-#ifdef _NC_WINDOWS
+#ifdef USE_WIN32CON_DRIVER
     {"win32console", &_nc_WIN_DRIVER},
 #endif
     {"tinfo", &_nc_TINFO_DRIVER}	/* must be last */
Index: ncurses/tinfo/write_entry.c
Prereq:  1.133 
--- ncurses-6.5-20240824+/ncurses/tinfo/write_entry.c	2024-07-27 19:15:16.000000000 +0000
+++ ncurses-6.5-20240831/ncurses/tinfo/write_entry.c	2024-08-31 10:46:01.000000000 +0000
@@ -42,7 +42,7 @@
 
 #include <tic.h>
 
-MODULE_ID("$Id: write_entry.c,v 1.133 2024/07/27 19:15:16 tom Exp $")
+MODULE_ID("$Id: write_entry.c,v 1.134 2024/08/31 10:46:01 Rafael.Kitover Exp $")
 
 #if 1
 #define TRACE_OUT(p) DEBUG(2, p)
@@ -200,7 +200,7 @@
 
 	if ((rc = stat(path, &statbuf)) == -1) {
 	    rc = mkdir(path
-#ifndef _NC_WINDOWS
+#ifndef _NC_WINDOWS_NATIVE
 		       ,0777
 #endif
 		);
Index: ncurses/trace/lib_trace.c
Prereq:  1.106 
--- ncurses-6.5-20240824+/ncurses/trace/lib_trace.c	2024-02-24 18:28:19.000000000 +0000
+++ ncurses-6.5-20240831/ncurses/trace/lib_trace.c	2024-08-31 10:48:22.000000000 +0000
@@ -48,7 +48,7 @@
 
 #include <ctype.h>
 
-MODULE_ID("$Id: lib_trace.c,v 1.106 2024/02/24 18:28:19 tom Exp $")
+MODULE_ID("$Id: lib_trace.c,v 1.107 2024/08/31 10:48:22 tom Exp $")
 
 NCURSES_EXPORT_VAR(unsigned) _nc_tracing = 0; /* always define this */
 
@@ -261,7 +261,7 @@
 	if ((pthread_self))
 # endif
 	    fprintf(fp, "%#" PRIxPTR ":",
-#ifdef _NC_WINDOWS
+#ifdef _NC_WINDOWS_NATIVE
 		    CASTxPTR(pthread_self().p)
 #else
 		    CASTxPTR(pthread_self())
Index: ncurses/widechar/widechars.c
Prereq:  1.9 
--- ncurses-6.5-20240824+/ncurses/widechar/widechars.c	2020-08-29 16:22:03.000000000 +0000
+++ ncurses-6.5-20240831/ncurses/widechar/widechars.c	2024-08-31 15:55:27.000000000 +0000
@@ -1,5 +1,5 @@
 /****************************************************************************
- * Copyright 2018,2020 Thomas E. Dickey                                     *
+ * Copyright 2018-2020,2024 Thomas E. Dickey                                *
  * Copyright 2012,2013 Free Software Foundation, Inc.                       *
  *                                                                          *
  * Permission is hereby granted, free of charge, to any person obtaining a  *
@@ -31,9 +31,9 @@
 
 #if USE_WIDEC_SUPPORT
 
-MODULE_ID("$Id: widechars.c,v 1.9 2020/08/29 16:22:03 juergen Exp $")
+MODULE_ID("$Id: widechars.c,v 1.10 2024/08/31 15:55:27 tom Exp $")
 
-#if (defined(_NC_WINDOWS)) && !defined(_NC_MSC)
+#if defined(_NC_MINGW)
 /*
  * MinGW has wide-character functions, but they do not work correctly.
  */
@@ -148,6 +148,6 @@
     return result;
 }
 
-#endif /* _NC_WINDOWS */
+#endif /* _NC_MINGW */
 
 #endif /* USE_WIDEC_SUPPORT */
Index: package/debian-mingw/changelog
--- ncurses-6.5-20240824+/package/debian-mingw/changelog	2024-08-24 10:17:07.000000000 +0000
+++ ncurses-6.5-20240831/package/debian-mingw/changelog	2024-08-31 09:52:35.000000000 +0000
@@ -1,8 +1,8 @@
-ncurses6td (6.5+20240824) unstable; urgency=low
+ncurses6td (6.5+20240831) unstable; urgency=low
 
   * latest weekly patch
 
- -- Thomas E. Dickey <dickey@invisible-island.net>  Sat, 24 Aug 2024 06:17:07 -0400
+ -- Thomas E. Dickey <dickey@invisible-island.net>  Sat, 31 Aug 2024 05:52:35 -0400
 
 ncurses6 (5.9+20131005) unstable; urgency=low
 
Index: package/debian-mingw64/changelog
--- ncurses-6.5-20240824+/package/debian-mingw64/changelog	2024-08-24 10:17:07.000000000 +0000
+++ ncurses-6.5-20240831/package/debian-mingw64/changelog	2024-08-31 09:52:35.000000000 +0000
@@ -1,8 +1,8 @@
-ncurses6td (6.5+20240824) unstable; urgency=low
+ncurses6td (6.5+20240831) unstable; urgency=low
 
   * latest weekly patch
 
- -- Thomas E. Dickey <dickey@invisible-island.net>  Sat, 24 Aug 2024 06:17:07 -0400
+ -- Thomas E. Dickey <dickey@invisible-island.net>  Sat, 31 Aug 2024 05:52:35 -0400
 
 ncurses6 (5.9+20131005) unstable; urgency=low
 
Index: package/debian/changelog
--- ncurses-6.5-20240824+/package/debian/changelog	2024-08-24 10:17:07.000000000 +0000
+++ ncurses-6.5-20240831/package/debian/changelog	2024-08-31 09:52:35.000000000 +0000
@@ -1,8 +1,8 @@
-ncurses6td (6.5+20240824) unstable; urgency=low
+ncurses6td (6.5+20240831) unstable; urgency=low
 
   * latest weekly patch
 
- -- Thomas E. Dickey <dickey@invisible-island.net>  Sat, 24 Aug 2024 06:17:07 -0400
+ -- Thomas E. Dickey <dickey@invisible-island.net>  Sat, 31 Aug 2024 05:52:35 -0400
 
 ncurses6 (5.9+20120608) unstable; urgency=low
 
Index: package/mingw-ncurses.nsi
Prereq:  1.663 
--- ncurses-6.5-20240824+/package/mingw-ncurses.nsi	2024-08-24 10:17:07.000000000 +0000
+++ ncurses-6.5-20240831/package/mingw-ncurses.nsi	2024-08-31 09:52:35.000000000 +0000
@@ -1,4 +1,4 @@
-; $Id: mingw-ncurses.nsi,v 1.663 2024/08/24 10:17:07 tom Exp $
+; $Id: mingw-ncurses.nsi,v 1.664 2024/08/31 09:52:35 tom Exp $
 
 ; TODO add examples
 ; TODO bump ABI to 6
@@ -10,7 +10,7 @@
 !define VERSION_MAJOR "6"
 !define VERSION_MINOR "5"
 !define VERSION_YYYY  "2024"
-!define VERSION_MMDD  "0824"
+!define VERSION_MMDD  "0831"
 !define VERSION_PATCH ${VERSION_YYYY}${VERSION_MMDD}
 
 !define MY_ABI   "5"
Index: package/mingw-ncurses.spec
--- ncurses-6.5-20240824+/package/mingw-ncurses.spec	2024-08-24 10:17:07.000000000 +0000
+++ ncurses-6.5-20240831/package/mingw-ncurses.spec	2024-08-31 09:52:35.000000000 +0000
@@ -3,7 +3,7 @@
 Summary: shared libraries for terminal handling
 Name: mingw32-ncurses6
 Version: 6.5
-Release: 20240824
+Release: 20240831
 License: X11
 Group: Development/Libraries
 URL: https://invisible-island.net/ncurses/
Index: package/ncurses.spec
--- ncurses-6.5-20240824+/package/ncurses.spec	2024-08-24 10:17:07.000000000 +0000
+++ ncurses-6.5-20240831/package/ncurses.spec	2024-08-31 09:52:35.000000000 +0000
@@ -1,7 +1,7 @@
 Summary: shared libraries for terminal handling
 Name: ncurses6
 Version: 6.5
-Release: 20240824
+Release: 20240831
 License: X11
 Group: Development/Libraries
 URL: https://invisible-island.net/ncurses/
Index: package/ncursest.spec
--- ncurses-6.5-20240824+/package/ncursest.spec	2024-08-24 10:17:07.000000000 +0000
+++ ncurses-6.5-20240831/package/ncursest.spec	2024-08-31 09:52:35.000000000 +0000
@@ -1,7 +1,7 @@
 Summary: Curses library with POSIX thread support.
 Name: ncursest6
 Version: 6.5
-Release: 20240824
+Release: 20240831
 License: X11
 Group: Development/Libraries
 Source: ncurses-%{version}-%{release}.tgz
Index: test/dots_termcap.c
Prereq:  1.32 
--- ncurses-6.5-20240824+/test/dots_termcap.c	2023-02-25 18:11:21.000000000 +0000
+++ ncurses-6.5-20240831/test/dots_termcap.c	2024-08-31 15:55:46.000000000 +0000
@@ -1,5 +1,5 @@
 /****************************************************************************
- * Copyright 2018-2022,2023 Thomas E. Dickey                                *
+ * Copyright 2018-2023,2024 Thomas E. Dickey                                *
  * Copyright 2013-2014,2017 Free Software Foundation, Inc.                  *
  *                                                                          *
  * Permission is hereby granted, free of charge, to any person obtaining a  *
@@ -30,14 +30,14 @@
 /*
  * Author: Thomas E. Dickey
  *
- * $Id: dots_termcap.c,v 1.32 2023/02/25 18:11:21 tom Exp $
+ * $Id: dots_termcap.c,v 1.33 2024/08/31 15:55:46 tom Exp $
  *
  * A simple demo of the termcap interface.
  */
 #define USE_TINFO
 #include <test.priv.h>
 
-#if !defined(_NC_WINDOWS)
+#if !defined(_NC_WINDOWS_NATIVE)
 #include <sys/time.h>
 #endif
 
@@ -162,7 +162,7 @@
 my_napms(int ms)
 {
     if (ms > 0) {
-#if defined(_NC_WINDOWS)
+#if defined(_NC_WINDOWS_NATIVE)
 	Sleep((unsigned int) ms);
 #else
 	struct timeval data;
Index: test/dots_xcurses.c
Prereq:  1.29 
--- ncurses-6.5-20240824+/test/dots_xcurses.c	2023-01-07 17:21:48.000000000 +0000
+++ ncurses-6.5-20240831/test/dots_xcurses.c	2024-08-31 15:55:52.000000000 +0000
@@ -1,5 +1,5 @@
 /****************************************************************************
- * Copyright 2018-2022,2023 Thomas E. Dickey                                *
+ * Copyright 2018-2023,2024 Thomas E. Dickey                                *
  * Copyright 2017 Free Software Foundation, Inc.                            *
  *                                                                          *
  * Permission is hereby granted, free of charge, to any person obtaining a  *
@@ -30,13 +30,13 @@
 /*
  * Author: Thomas E. Dickey
  *
- * $Id: dots_xcurses.c,v 1.29 2023/01/07 17:21:48 tom Exp $
+ * $Id: dots_xcurses.c,v 1.30 2024/08/31 15:55:52 tom Exp $
  *
  * A simple demo of the wide-curses interface used for comparison with termcap.
  */
 #include <test.priv.h>
 
-#if !defined(_NC_WINDOWS)
+#if !defined(_NC_WINDOWS_NATIVE)
 #include <sys/time.h>
 #endif
 
Index: test/rain.c
Prereq:  1.57 
--- ncurses-6.5-20240824+/test/rain.c	2022-12-04 00:40:11.000000000 +0000
+++ ncurses-6.5-20240831/test/rain.c	2024-08-31 15:56:10.000000000 +0000
@@ -1,5 +1,5 @@
 /****************************************************************************
- * Copyright 2018-2020,2022 Thomas E. Dickey                                *
+ * Copyright 2018-2022,2024 Thomas E. Dickey                                *
  * Copyright 1998-2014,2017 Free Software Foundation, Inc.                  *
  *                                                                          *
  * Permission is hereby granted, free of charge, to any person obtaining a  *
@@ -27,7 +27,7 @@
  * authorization.                                                           *
  ****************************************************************************/
 /*
- * $Id: rain.c,v 1.57 2022/12/04 00:40:11 tom Exp $
+ * $Id: rain.c,v 1.58 2024/08/31 15:56:10 tom Exp $
  */
 #include <test.priv.h>
 #include <popup_msg.h>
@@ -229,7 +229,7 @@
      * Find myself in the list of threads so we can count the number of loops.
      */
     for (mystats = 0; mystats < MAX_THREADS; ++mystats) {
-#if defined(_NC_WINDOWS) && !defined(__WINPTHREADS_VERSION)
+#if defined(_NC_WINDOWS_NATIVE) && !defined(__WINPTHREADS_VERSION)
 	if (drop_threads[mystats].myself.p == pthread_self().p)
 #else
 	if (drop_threads[mystats].myself == pthread_self())
Index: test/test.priv.h
Prereq:  1.218 
--- ncurses-6.5-20240824+/test/test.priv.h	2024-02-10 14:40:03.000000000 +0000
+++ ncurses-6.5-20240831/test/test.priv.h	2024-08-31 10:46:01.000000000 +0000
@@ -30,7 +30,7 @@
 /****************************************************************************
  *  Author: Thomas E. Dickey                    1996-on                     *
  ****************************************************************************/
-/* $Id: test.priv.h,v 1.218 2024/02/10 14:40:03 tom Exp $ */
+/* $Id: test.priv.h,v 1.219 2024/08/31 10:46:01 Rafael.Kitover Exp $ */
 
 #ifndef __TEST_PRIV_H
 #define __TEST_PRIV_H 1
@@ -1047,12 +1047,12 @@
 #define EXIT_FAILURE 1
 #endif
 
-#undef _NC_WINDOWS
+#undef _NC_WINDOWS_NATIVE
 #if (defined(_WIN32) || defined(_WIN64))
-#define _NC_WINDOWS 1
+#define _NC_WINDOWS_NATIVE 1
 #endif
 
-#if defined(_NC_WINDOWS) || defined(USE_WIN32CON_DRIVER)
+#if defined(_NC_WINDOWS_NATIVE) || defined(USE_WIN32CON_DRIVER)
 
 #if defined(PDCURSES)
 #ifdef WINVER
@@ -1184,7 +1184,7 @@
 #define InitAndCatch(init,handler) do { init; CATCHALL(handler); } while (0)
 #endif
 
-#if defined(_NC_WINDOWS) || defined(USE_WIN32CON_DRIVER)
+#if defined(_NC_WINDOWS_NATIVE) || defined(USE_WIN32CON_DRIVER)
 #define SetupAlarm(opt)	(void)opt
 #else
 #define SetupAlarm(opt)	if (opt) alarm((unsigned)opt)
Index: test/test_mouse.c
Prereq:  1.31 
--- ncurses-6.5-20240824+/test/test_mouse.c	2024-03-30 20:45:31.000000000 +0000
+++ ncurses-6.5-20240831/test/test_mouse.c	2024-08-31 10:46:01.000000000 +0000
@@ -22,7 +22,7 @@
  * THE USE OR OTHER DEALINGS IN THE SOFTWARE.                               *
  ****************************************************************************/
 /*
- * $Id: test_mouse.c,v 1.31 2024/03/30 20:45:31 tom Exp $
+ * $Id: test_mouse.c,v 1.32 2024/08/31 10:46:01 Rafael.Kitover Exp $
  *
  * Author: Leonid S Usov
  *
@@ -31,7 +31,7 @@
 
 #include <test.priv.h>
 
-#if defined(NCURSES_MOUSE_VERSION) && !defined(_NC_WINDOWS)
+#if defined(NCURSES_MOUSE_VERSION) && !defined(_NC_WINDOWS_NATIVE)
 
 static int logoffset = 0;
 
Index: test/widechars.h
--- ncurses-6.5-20240824+/test/widechars.h	2020-09-13 00:20:21.000000000 +0000
+++ ncurses-6.5-20240831/test/widechars.h	2024-08-31 15:56:21.000000000 +0000
@@ -1,5 +1,5 @@
 /****************************************************************************
- * Copyright 2018,2020 Thomas E. Dickey                                     *
+ * Copyright 2018-2020,2024 Thomas E. Dickey                                *
  * Copyright 2012 Free Software Foundation, Inc.                            *
  *                                                                          *
  * Permission is hereby granted, free of charge, to any person obtaining a  *
@@ -34,7 +34,7 @@
 
 #if USE_WIDEC_SUPPORT
 
-#if defined(_NC_WINDOWS) && !defined(_MSC_VER) && !defined(EXP_WIN32_DRIVER)
+#if defined(_NC_MINGW)
 /*
  * MinGW has wide-character functions, but they do not work correctly.
  */
