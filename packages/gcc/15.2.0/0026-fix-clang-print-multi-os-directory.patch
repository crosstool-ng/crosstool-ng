From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Ahmed ARIF <arif.ing@outlook.com>
Date: Mon, 12 Jan 2026 00:00:00 +0000
Subject: [PATCH] gcc: fix clang print-multi-os-directory fallback

When using clang as the host compiler, -print-multi-os-directory may
fail. Add error handling to default to "." when the command fails.

--- a/libgfortran/configure
+++ b/libgfortran/configure
@@ -5203,7 +5203,10 @@
       toolexecdir='$(libdir)/gcc-lib/$(target_alias)'
       toolexeclibdir='$(libdir)'
     fi
-    multi_os_directory=`$CC -print-multi-os-directory`
+    multi_os_directory=`$CC -print-multi-os-directory 2>/dev/null`
+    if test $? -ne 0 || test -z "$multi_os_directory"; then
+      multi_os_directory="."
+    fi
     case $multi_os_directory in
       .) ;; # Avoid trailing /.
       *) toolexeclibdir=$toolexeclibdir/$multi_os_directory ;;
@@ -11734,6 +11737,9 @@
   # and add multilib dir if necessary.
   lt_tmp_lt_search_path_spec=
   lt_multi_os_dir=`$CC $CPPFLAGS $CFLAGS $LDFLAGS -print-multi-os-directory 2>/dev/null`
+  if test $? -ne 0 || test -z "$lt_multi_os_dir"; then
+    lt_multi_os_dir="."
+  fi
   for lt_sys_path in $lt_search_path_spec; do
     if test -d "$lt_sys_path/$lt_multi_os_dir"; then
       lt_tmp_lt_search_path_spec="$lt_tmp_lt_search_path_spec $lt_sys_path/$lt_multi_os_dir"
--- a/libstdc++-v3/configure
+++ b/libstdc++-v3/configure
@@ -11167,6 +11167,9 @@
   # and add multilib dir if necessary.
   lt_tmp_lt_search_path_spec=
   lt_multi_os_dir=`$CC $CPPFLAGS $CFLAGS $LDFLAGS -print-multi-os-directory 2>/dev/null`
+  if test $? -ne 0 || test -z "$lt_multi_os_dir"; then
+    lt_multi_os_dir="."
+  fi
   for lt_sys_path in $lt_search_path_spec; do
     if test -d "$lt_sys_path/$lt_multi_os_dir"; then
       lt_tmp_lt_search_path_spec="$lt_tmp_lt_search_path_spec $lt_sys_path/$lt_multi_os_dir"
@@ -55733,7 +55736,10 @@
       glibcxx_toolexecdir='${libdir}/gcc/${host_alias}'
       glibcxx_toolexeclibdir='${libdir}'
     fi
-    multi_os_directory=`$CXX -print-multi-os-directory`
+    multi_os_directory=`$CXX -print-multi-os-directory 2>/dev/null`
+    if test $? -ne 0 || test -z "$multi_os_directory"; then
+      multi_os_directory="."
+    fi
     case $multi_os_directory in
       .) ;; # Avoid trailing /.
       *) glibcxx_toolexeclibdir=$glibcxx_toolexeclibdir/$multi_os_directory ;;
--- a/gcc/configure
+++ b/gcc/configure
@@ -20425,6 +20425,9 @@
   # and add multilib dir if necessary.
   lt_tmp_lt_search_path_spec=
   lt_multi_os_dir=`$CC $CPPFLAGS $CFLAGS $LDFLAGS -print-multi-os-directory 2>/dev/null`
+  if test $? -ne 0 || test -z "$lt_multi_os_dir"; then
+    lt_multi_os_dir="."
+  fi
   for lt_sys_path in $lt_search_path_spec; do
     if test -d "$lt_sys_path/$lt_multi_os_dir"; then
       lt_tmp_lt_search_path_spec="$lt_tmp_lt_search_path_spec $lt_sys_path/$lt_multi_os_dir"
--- a/libatomic/configure
+++ b/libatomic/configure
@@ -3399,7 +3399,10 @@
       toolexecdir='$(libdir)/gcc-lib/$(target_alias)'
       toolexeclibdir='$(libdir)'
     fi
-    multi_os_directory=`$CC -print-multi-os-directory`
+    multi_os_directory=`$CC -print-multi-os-directory 2>/dev/null`
+    if test $? -ne 0 || test -z "$multi_os_directory"; then
+      multi_os_directory="."
+    fi
     case $multi_os_directory in
       .) ;; # Avoid trailing /.
       *) toolexeclibdir=$toolexeclibdir/$multi_os_directory ;;
@@ -10361,6 +10364,9 @@
   # and add multilib dir if necessary.
   lt_tmp_lt_search_path_spec=
   lt_multi_os_dir=`$CC $CPPFLAGS $CFLAGS $LDFLAGS -print-multi-os-directory 2>/dev/null`
+  if test $? -ne 0 || test -z "$lt_multi_os_dir"; then
+    lt_multi_os_dir="."
+  fi
   for lt_sys_path in $lt_search_path_spec; do
     if test -d "$lt_sys_path/$lt_multi_os_dir"; then
       lt_tmp_lt_search_path_spec="$lt_tmp_lt_search_path_spec $lt_sys_path/$lt_multi_os_dir"
--- a/libgomp/configure
+++ b/libgomp/configure
@@ -3517,7 +3517,10 @@
       toolexecdir='$(libdir)/gcc-lib/$(target_alias)'
       toolexeclibdir='$(libdir)'
     fi
-    multi_os_directory=`$CC -print-multi-os-directory`
+    multi_os_directory=`$CC -print-multi-os-directory 2>/dev/null`
+    if test $? -ne 0 || test -z "$multi_os_directory"; then
+      multi_os_directory="."
+    fi
     case $multi_os_directory in
       .) ;; # Avoid trailing /.
       *) toolexeclibdir=$toolexeclibdir/$multi_os_directory ;;
@@ -10374,6 +10377,9 @@
   # and add multilib dir if necessary.
   lt_tmp_lt_search_path_spec=
   lt_multi_os_dir=`$CC $CPPFLAGS $CFLAGS $LDFLAGS -print-multi-os-directory 2>/dev/null`
+  if test $? -ne 0 || test -z "$lt_multi_os_dir"; then
+    lt_multi_os_dir="."
+  fi
   for lt_sys_path in $lt_search_path_spec; do
     if test -d "$lt_sys_path/$lt_multi_os_dir"; then
       lt_tmp_lt_search_path_spec="$lt_tmp_lt_search_path_spec $lt_sys_path/$lt_multi_os_dir"
--- a/libitm/configure
+++ b/libitm/configure
@@ -3581,7 +3581,10 @@
       toolexecdir='$(libdir)/gcc-lib/$(target_alias)'
       toolexeclibdir='$(libdir)'
     fi
-    multi_os_directory=`$CC -print-multi-os-directory`
+    multi_os_directory=`$CC -print-multi-os-directory 2>/dev/null`
+    if test $? -ne 0 || test -z "$multi_os_directory"; then
+      multi_os_directory="."
+    fi
     case $multi_os_directory in
       .) ;; # Avoid trailing /.
       *) toolexeclibdir=$toolexeclibdir/$multi_os_directory ;;
@@ -11036,6 +11039,9 @@
   # and add multilib dir if necessary.
   lt_tmp_lt_search_path_spec=
   lt_multi_os_dir=`$CC $CPPFLAGS $CFLAGS $LDFLAGS -print-multi-os-directory 2>/dev/null`
+  if test $? -ne 0 || test -z "$lt_multi_os_dir"; then
+    lt_multi_os_dir="."
+  fi
   for lt_sys_path in $lt_search_path_spec; do
     if test -d "$lt_sys_path/$lt_multi_os_dir"; then
       lt_tmp_lt_search_path_spec="$lt_tmp_lt_search_path_spec $lt_sys_path/$lt_multi_os_dir"
--- a/libsanitizer/configure
+++ b/libsanitizer/configure
@@ -5072,7 +5072,10 @@
       toolexecdir='$(libdir)/gcc-lib/$(target_alias)'
       toolexeclibdir='$(libdir)'
     fi
-    multi_os_directory=`$CC -print-multi-os-directory`
+    multi_os_directory=`$CC -print-multi-os-directory 2>/dev/null`
+    if test $? -ne 0 || test -z "$multi_os_directory"; then
+      multi_os_directory="."
+    fi
     case $multi_os_directory in
       .) ;; # Avoid trailing /.
       *) toolexeclibdir=$toolexeclibdir/$multi_os_directory ;;
@@ -11380,6 +11383,9 @@
   # and add multilib dir if necessary.
   lt_tmp_lt_search_path_spec=
   lt_multi_os_dir=`$CC $CPPFLAGS $CFLAGS $LDFLAGS -print-multi-os-directory 2>/dev/null`
+  if test $? -ne 0 || test -z "$lt_multi_os_dir"; then
+    lt_multi_os_dir="."
+  fi
   for lt_sys_path in $lt_search_path_spec; do
     if test -d "$lt_sys_path/$lt_multi_os_dir"; then
       lt_tmp_lt_search_path_spec="$lt_tmp_lt_search_path_spec $lt_sys_path/$lt_multi_os_dir"
--- a/libquadmath/configure
+++ b/libquadmath/configure
@@ -9809,6 +9809,9 @@
   # and add multilib dir if necessary.
   lt_tmp_lt_search_path_spec=
   lt_multi_os_dir=`$CC $CPPFLAGS $CFLAGS $LDFLAGS -print-multi-os-directory 2>/dev/null`
+  if test $? -ne 0 || test -z "$lt_multi_os_dir"; then
+    lt_multi_os_dir="."
+  fi
   for lt_sys_path in $lt_search_path_spec; do
     if test -d "$lt_sys_path/$lt_multi_os_dir"; then
       lt_tmp_lt_search_path_spec="$lt_tmp_lt_search_path_spec $lt_sys_path/$lt_multi_os_dir"
@@ -12251,7 +12254,10 @@
       toolexecdir='$(libdir)/gcc-lib/$(target_alias)'
       toolexeclibdir='$(libdir)'
     fi
-    multi_os_directory=`$CC -print-multi-os-directory`
+    multi_os_directory=`$CC -print-multi-os-directory 2>/dev/null`
+    if test $? -ne 0 || test -z "$multi_os_directory"; then
+      multi_os_directory="."
+    fi
     case $multi_os_directory in
       .) ;; # Avoid trailing /.
       *) toolexeclibdir=$toolexeclibdir/$multi_os_directory ;;
--- a/libssp/configure
+++ b/libssp/configure
@@ -10051,6 +10051,9 @@
   # and add multilib dir if necessary.
   lt_tmp_lt_search_path_spec=
   lt_multi_os_dir=`$CC $CPPFLAGS $CFLAGS $LDFLAGS -print-multi-os-directory 2>/dev/null`
+  if test $? -ne 0 || test -z "$lt_multi_os_dir"; then
+    lt_multi_os_dir="."
+  fi
   for lt_sys_path in $lt_search_path_spec; do
     if test -d "$lt_sys_path/$lt_multi_os_dir"; then
       lt_tmp_lt_search_path_spec="$lt_tmp_lt_search_path_spec $lt_sys_path/$lt_multi_os_dir"
@@ -11584,7 +11587,10 @@
       toolexecdir='$(libdir)/gcc-lib/$(target_alias)'
       toolexeclibdir='$(libdir)'
     fi
-    multi_os_directory=`$CC -print-multi-os-directory`
+    multi_os_directory=`$CC -print-multi-os-directory 2>/dev/null`
+    if test $? -ne 0 || test -z "$multi_os_directory"; then
+      multi_os_directory="."
+    fi
     case $multi_os_directory in
       .) ;; # Avoid trailing /.
       *) toolexeclibdir=$toolexeclibdir/$multi_os_directory ;;
--- a/libvtv/configure
+++ b/libvtv/configure
@@ -4860,7 +4860,10 @@
       toolexecdir='$(libdir)/gcc-lib/$(target_alias)'
       toolexeclibdir='$(libdir)'
     fi
-    multi_os_directory=`$CC -print-multi-os-directory`
+    multi_os_directory=`$CC -print-multi-os-directory 2>/dev/null`
+    if test $? -ne 0 || test -z "$multi_os_directory"; then
+      multi_os_directory="."
+    fi
     case $multi_os_directory in
       .) ;; # Avoid trailing /.
       *) toolexeclibdir=$toolexeclibdir/$multi_os_directory ;;
@@ -11274,6 +11277,9 @@
   # and add multilib dir if necessary.
   lt_tmp_lt_search_path_spec=
   lt_multi_os_dir=`$CC $CPPFLAGS $CFLAGS $LDFLAGS -print-multi-os-directory 2>/dev/null`
+  if test $? -ne 0 || test -z "$lt_multi_os_dir"; then
+    lt_multi_os_dir="."
+  fi
   for lt_sys_path in $lt_search_path_spec; do
     if test -d "$lt_sys_path/$lt_multi_os_dir"; then
       lt_tmp_lt_search_path_spec="$lt_tmp_lt_search_path_spec $lt_sys_path/$lt_multi_os_dir"
